package com.horstmann.violet.application.gui.util.ckt.testcase;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Random;


import org.dom4j.Document;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;
import org.dom4j.io.OutputFormat;
import org.dom4j.io.XMLWriter;

import com.horstmann.violet.application.gui.util.ckt.handle.*;
import com.horstmann.violet.application.gui.util.ckt.testcase.*;
import com.horstmann.violet.application.gui.util.wj.util.*;

public class PerformanceXML {
	public static void main(String[] args) throws Exception {
		//String xml="UAVForXStreamPerformTestV6.xml";//性能测试，主要测试高度、风速、风向
		//String xml="UAVForXStreamGaoDu-v6.xml"; //性能测试，主要测高度
		String xml = "UAVForXStreamXuanTing.xml";//性能测试，主要测悬停
		Automatic auto=GetAutomatic.getAutomatic(xml);//获得原始的时间自动机
		Automatic a=GeneratePath.getPerformPathFromAutomatic(auto);//获得满足状态覆盖的抽象测试序列

		// 1、创建document对象，代表整个xml文档
		Document dom = DocumentHelper.createDocument();
		// 2、创建根节点TCS
		org.dom4j.Element tcs = dom.addElement("TCS");
		// 3、向TCS节点中添加version属性

		int i = 1;					
		List<List<String>> cases = new ArrayList<List<String>>(); // 测试用例集合
		List<String> outtt=new ArrayList<String>();//out输出
		System.out.println("===========================正在读取第"+i+"条测试用例");
		System.out.println("  ===>  测试用例名字:"+a.getName());
		int j = 1;
		for(Transition tran:a.getTransitionSet()){
			System.out.println();
			System.out.println("======第"+j+"条迁移开始======");
			System.out.println("迁移内容:"+tran.getIn()+"---"+tran.getCondition());
			String sss = new String();
			List<String> result1=new ArrayList<String>();//存放in里面最终实例化结果
			List<String> result2=new ArrayList<String>();//存放condition里面最终实例化结果
			if(tran.getName().contains("(")){
				int index11=tran.getName().replace("!", "").replace("?", "").indexOf("(");
				sss=tran.getName().substring(0,index11);
				System.out.println("迁移(激励)名称："+sss);
			}
			else{
				sss = tran.getName().replace("!", "").replace("?", "");
				System.out.println("迁移(激励)名称："+sss);
			}
			System.out.println("迁移Id："+tran.getId());								
			//System.out.println("源状态名称："+tran.getSource());
			//System.out.println("目的状态名称："+tran.getTarget());
			//未处理的约束条件	
			//System.out.println("约束："+tran.getEventSet());//约束不等式


			/**
			 * 处理in里面的不等式和参数，实例化in
			 */
			//处理in里面的不等式和参数，得到参数类型与参数一一对应的map，进行添加不等式操作
			//System.out.println("========================in========================");	
			System.out.println("in---->"+tran.getIn());	//in里面的内容	
			if(tran.getIn().equals("null")){	
				result1.add(null);
			}else{				
				result1=Result1.preInResult(tran.getIn());
			}	

			/**
			 * 处理condition里面的不等式和参数，实例化condition
			 */

			//System.out.println("condition---->"+tran.getCondition());
			if(tran.getCondition().equals("null")){	
				result2.add(null);
			}else{
				if(!tran.getCondition().equals("null")){
					if(GetMap.get_condMap(tran.getCondition())==null){
						result2.add(null);
					}else{
						if(!(GetMap.get_condMap(tran.getCondition())==null)){
							String tra = tran.getCondition().replace("false", "False").replace("true", "True").replace("->", "$");
							//result2 = Result.getResult(tra);
							System.out.println("tra----"+tra);
							result2 = Result1.getResult(tra);
							//result2 = testbdscs.getResult(tra);						
							for(int ii=0;ii<result2.size();ii++){
								//System.out.println("condition里解"+ii+"为:"+result2.get(ii));
							}
						}
					}

				}					
			}

			/**
			 * 处理out里面要输出的信息，存储到xml中
			 * ckt要输出信息ckt
			 */
			String outP=new String();
			String s1=new String();
			if(tran.getOut().contains("ckt")){
				String[] out = tran.getOut().split(",");
				List<String> output = new ArrayList<String>();
				for(String s:out){
					if(s.contains("ckt")){
						String ss = s.replace("ckt", "");
						output.add(ss);
					}
				}					
				if(output.size()>1){
					outP=output.get(0);
					for(int j1=1;j1<output.size();j1++){
						s1=output.get(j);
						outP=outP+","+s1;
					}
				}
				if(output.size()==1){
					outP=output.get(0);
				}	
				if(output.size()<=0){
					outP="null";
				}
				outtt.add(outP);
			}else{
				outP="null";
				outtt.add(outP);
			}
			/**
			 * 把in与condition上解组合在一起
			 * 格式：激励名称%in与condition上解%out里要输出的信息
			 * 组合的放在result内
			 */
			List<String> result=new ArrayList<String>();//存放一条迁移上的结果
			String res = new String();
			if((result1.toString().equals("[null]"))&&(result2.toString().equals("[null]"))){
				res = sss+"%"+null+"%"+outP;
				//res = null;
				result.add(res.toString());
			}else{
				if(!(result1.toString().equals("[null]"))&&(result2.toString().equals("[null]"))){
					for(String ttt2:result1){
						if(ttt2!=null){
							if(ttt2.contains("flag=1")){
								res = sss+"flag=1"+"%"+ttt2.replace("flag=1", "")+"%"+outP;
							}else{
								res = sss+"%"+ttt2+"%"+outP;
							}

							//res = ttt2;
							result.add(res.toString());
						}
					}
				}
				if((result1.toString().equals("[null]"))&&!(result2.toString().equals("[null]"))){
					for(String ttt3:result2){
						if(ttt3!=null){
							if(ttt3.contains("flag=1")){
								res = sss+"flag=1"+"%"+ttt3.replace("flag=1", "")+"%"+outP;
							}else{
								res = sss+"%"+ttt3+"%"+outP;
							}
							//res = sss+"%"+ttt3;
							//res = ttt3;
							result.add(res.toString());
						}
					}
				}
				if(!(result1.toString().equals("[null]"))&&!(result2.toString().equals("[null]"))){
					for(String ttt2:result1){
						for(String ttt3:result2){
							if(ttt2!=null&&ttt3!=null){
								if((ttt2.contains("flag=1"))||(ttt3.contains("flag=1"))){
									res = sss+"flag=1"+"%"+ttt2.replace("flag=1", "")+","+ttt3.replace("flag=1", "")+"%"+outP;
								}else{
									if(!(ttt2.contains("flag=1"))&&!(ttt3.contains("flag=1"))){
										res = sss+"%"+ttt2+","+ttt3+"%"+outP;
									}
								}
								//res = sss+"%"+ttt2+","+ttt3;
								//res = ttt2+","+ttt3;
								result.add(res.toString());
							}									
						}
					}
				}
			}	
			System.out.println("result--------------"+result);
			if(result.size()==0){
				//System.out.println("-----------------0000000---------------------");
				//Element input = process.addElement("input");
				//input.setText("解1为:"+null);
			}else{
				for(int ii=1;ii<=result.size();ii++){
					System.out.println("解"+ii+"为:"+result.get(ii-1));//输出所有解
					String s = "解"+ii+"为:"+result.get(ii-1);
					//Element input = process.addElement("input");
					//input.setText(s);
				}					
			}
			cases.add(result);
			////////////////////////////////////////////////////////////////////////////////////
			//System.out.println("                 ======第"+j+"条迁移结束======");
			j++;
		}//for(Transition tran:a.getTransitionSet())
		/**
		 * 数据写进xml文档里
		 */
		//把解拼接在一起
		List<String> casess = new ArrayList<String>();
		dis(0,cases);
		casess = re;
		List<String> ret = new ArrayList<String>();
		re = ret;
		//cases里放的是一条测试用例上上每条迁移上的解，result放的是一条迁移上的多组解
		/////
		/*int numm=1;
		for(int nn=0;nn<cases.size();nn++){
			int n = cases.get(nn).size();
			numm = numm*n;
			//System.out.println("第"+nn+"条迁移上解个数为："+cases.get(nn).size());
		}*/
		int numm = casess.size();
		System.out.println("第"+i+"条测试路径上解个数"+numm);
		int num=1000;//一条路径100个测试用例///////////////////////////////////////////////////////////////////////////////////
		if(num>numm){   //如果一条路径上解小于100，则选取真实个数
			num = numm;
		}
		for(int n1=0;n1<num;n1++){
			// 4、生成子节点及节点内容
			Element testcase = tcs.addElement("testcase");
			//System.out.println("---------------------testcase"+n1);
			for(int nn=0;nn<cases.size();nn++){//cases.size表示边的个数
				//添加节点
				Element process = testcase.addElement("process");
				Element operation = process.addElement("operation");			
				int random = -1;
				if (random == -1) {
					random = new Random().nextInt(cases.get(nn).size());
				}
				//System.out.println("random-->"+random);
				String value = cases.get(nn).get(random);
				//System.out.println("解value-->"+value);
				String[] cs =value.toString().split("%");
				//System.out.println("operation-->"+cs[0]);
				if(cs[0].contains("flag=1")){
					String name = cs[0].replace("flag=1", "");
					operation.setText(name);
				}else{
					if(!cs[0].contains("flag=1")){
						operation.setText(cs[0]);
					}
				}

				Element input = process.addElement("input");
				if(cs[0].contains("flag=1")){
					input.addAttribute("border","1");
					input.setText(cs[1]);
				}else{
					input.setText(cs[1]);
				}
				//input.setText(cs[1]);
				//System.out.println("input-->"+cs[1]);
				Element output = process.addElement("output");
				//System.out.println(outtt.get(nn).toString());
				output.setText(cs[2]);

			}
			//System.out.println("---------------------testcase");
			//System.out.println(a.getName());
		}
		////////
		//System.out.println("===========================第"+i+"条测试用例读取完成");
		i++;


		//}//for(Automatic a:testCase)

		//System.out.println("抽象测试序列个数："+testCase.size());
		System.out.println();
		/////////////////////
		/////////////////////

		OutputFormat format = OutputFormat.createPrettyPrint();
		//6、生成xml文件
		File file = new File("E:\\项目\\xml\\UAVForXStreamXuanTing+__border+path+perform.xml");
   
		XMLWriter writer;
		try {
			writer = new XMLWriter(new FileOutputStream(file), format);
			writer.write(dom);
			writer.close();
		} catch (IOException e) {
			e.printStackTrace();
		}


	}

	public static String s="";
	public static List<String> re = new ArrayList<String>();
	public static void dis(int n, List<List<String>> l) {
		if (n == l.size()) {
			re.add(s);
			return;
		} else {
			List<String> sCollection = l.get(n);
			for (int i = 0; i < sCollection.size(); i++) {
				String s1 = s;
				if(s==""){
					s  = sCollection.get(i);
				}else{
					s =s + ","+ sCollection.get(i);
				}				
				dis(n+1,l);
				s = s1;
			}
		}
	}
	
	public static void createXML(Automatic a, String path) {

		// 1、创建document对象，代表整个xml文档
		Document dom = DocumentHelper.createDocument();
		// 2、创建根节点TCS
		org.dom4j.Element tcs = dom.addElement("TCS");
		// 3、向TCS节点中添加version属性

		int i = 1;
		List<List<String>> cases = new ArrayList<List<String>>(); // 测试用例集合
		List<String> outtt = new ArrayList<String>();// out输出
		System.out.println("===========================正在读取第" + i + "条测试用例");
		System.out.println("  ===>  测试用例名字:" + a.getName());
		int j = 1;
		for (Transition tran : a.getTransitionSet()) {
			System.out.println();
			System.out.println("======第" + j + "条迁移开始======");
			System.out.println("迁移内容:" + tran.getIn() + "---" + tran.getCondition());
			String sss = new String();
			List<String> result1 = new ArrayList<String>();// 存放in里面最终实例化结果
			List<String> result2 = new ArrayList<String>();// 存放condition里面最终实例化结果
			if (tran.getName().contains("(")) {
				int index11 = tran.getName().replace("!", "").replace("?", "").indexOf("(");
				sss = tran.getName().substring(0, index11);
				System.out.println("迁移(激励)名称：" + sss);
			} else {
				sss = tran.getName().replace("!", "").replace("?", "");
				System.out.println("迁移(激励)名称：" + sss);
			}
			System.out.println("迁移Id：" + tran.getId());
			// System.out.println("源状态名称："+tran.getSource());
			// System.out.println("目的状态名称："+tran.getTarget());
			// 未处理的约束条件
			// System.out.println("约束："+tran.getEventSet());//约束不等式

			/**
			 * 处理in里面的不等式和参数，实例化in
			 */
			// 处理in里面的不等式和参数，得到参数类型与参数一一对应的map，进行添加不等式操作
			// System.out.println("========================in========================");
			System.out.println("in---->" + tran.getIn()); // in里面的内容
			if (tran.getIn().equals("null")) {
				result1.add(null);
			} else {
				result1 = Result1.preInResult(tran.getIn());
			}

			/**
			 * 处理condition里面的不等式和参数，实例化condition
			 */

			// System.out.println("condition---->"+tran.getCondition());
			if (tran.getCondition().equals("null")) {
				result2.add(null);
			} else {
				if (!tran.getCondition().equals("null")) {
					if (GetMap.get_condMap(tran.getCondition()) == null) {
						result2.add(null);
					} else {
						if (!(GetMap.get_condMap(tran.getCondition()) == null)) {
							String tra = tran.getCondition().replace("false", "False").replace("true", "True")
									.replace("->", "$");
							// result2 = Result.getResult(tra);
							System.out.println("tra----" + tra);
							result2 = Result1.getResult(tra);
							// result2 = testbdscs.getResult(tra);
							for (int ii = 0; ii < result2.size(); ii++) {
								// System.out.println("condition里解"+ii+"为:"+result2.get(ii));
							}
						}
					}

				}
			}

			/**
			 * 处理out里面要输出的信息，存储到xml中 ckt要输出信息ckt
			 */
			String outP = new String();
			String s1 = new String();
			if (tran.getOut().contains("ckt")) {
				String[] out = tran.getOut().split(",");
				List<String> output = new ArrayList<String>();
				for (String s : out) {
					if (s.contains("ckt")) {
						String ss = s.replace("ckt", "");
						output.add(ss);
					}
				}
				if (output.size() > 1) {
					outP = output.get(0);
					for (int j1 = 1; j1 < output.size(); j1++) {
						s1 = output.get(j);
						outP = outP + "," + s1;
					}
				}
				if (output.size() == 1) {
					outP = output.get(0);
				}
				if (output.size() <= 0) {
					outP = "null";
				}
				outtt.add(outP);
			} else {
				outP = "null";
				outtt.add(outP);
			}
			/**
			 * 把in与condition上解组合在一起 格式：激励名称%in与condition上解%out里要输出的信息
			 * 组合的放在result内
			 */
			List<String> result = new ArrayList<String>();// 存放一条迁移上的结果
			String res = new String();
			if ((result1.toString().equals("[null]")) && (result2.toString().equals("[null]"))) {
				res = sss + "%" + null + "%" + outP;
				// res = null;
				result.add(res.toString());
			} else {
				if (!(result1.toString().equals("[null]")) && (result2.toString().equals("[null]"))) {
					for (String ttt2 : result1) {
						if (ttt2 != null) {
							if (ttt2.contains("flag=1")) {
								res = sss + "flag=1" + "%" + ttt2.replace("flag=1", "") + "%" + outP;
							} else {
								res = sss + "%" + ttt2 + "%" + outP;
							}

							// res = ttt2;
							result.add(res.toString());
						}
					}
				}
				if ((result1.toString().equals("[null]")) && !(result2.toString().equals("[null]"))) {
					for (String ttt3 : result2) {
						if (ttt3 != null) {
							if (ttt3.contains("flag=1")) {
								res = sss + "flag=1" + "%" + ttt3.replace("flag=1", "") + "%" + outP;
							} else {
								res = sss + "%" + ttt3 + "%" + outP;
							}
							// res = sss+"%"+ttt3;
							// res = ttt3;
							result.add(res.toString());
						}
					}
				}
				if (!(result1.toString().equals("[null]")) && !(result2.toString().equals("[null]"))) {
					for (String ttt2 : result1) {
						for (String ttt3 : result2) {
							if (ttt2 != null && ttt3 != null) {
								if ((ttt2.contains("flag=1")) || (ttt3.contains("flag=1"))) {
									res = sss + "flag=1" + "%" + ttt2.replace("flag=1", "") + ","
											+ ttt3.replace("flag=1", "") + "%" + outP;
								} else {
									if (!(ttt2.contains("flag=1")) && !(ttt3.contains("flag=1"))) {
										res = sss + "%" + ttt2 + "," + ttt3 + "%" + outP;
									}
								}
								// res = sss+"%"+ttt2+","+ttt3;
								// res = ttt2+","+ttt3;
								result.add(res.toString());
							}
						}
					}
				}
			}
			System.out.println("result--------------" + result);
			if (result.size() == 0) {
				// System.out.println("-----------------0000000---------------------");
				// Element input = process.addElement("input");
				// input.setText("解1为:"+null);
			} else {
				for (int ii = 1; ii <= result.size(); ii++) {
					System.out.println("解" + ii + "为:" + result.get(ii - 1));// 输出所有解
					String s = "解" + ii + "为:" + result.get(ii - 1);
					// Element input = process.addElement("input");
					// input.setText(s);
				}
			}
			cases.add(result);
			////////////////////////////////////////////////////////////////////////////////////
			// System.out.println(" ======第"+j+"条迁移结束======");
			j++;
		} // for(Transition tran:a.getTransitionSet())
		/**
		 * 数据写进xml文档里
		 */
		// 把解拼接在一起
		List<String> casess = new ArrayList<String>();
		dis(0, cases);
		casess = re;
		List<String> ret = new ArrayList<String>();
		re = ret;
		// cases里放的是一条测试用例上上每条迁移上的解，result放的是一条迁移上的多组解
		/////
		/*
		 * int numm=1; for(int nn=0;nn<cases.size();nn++){ int n =
		 * cases.get(nn).size(); numm = numm*n;
		 * //System.out.println("第"+nn+"条迁移上解个数为："+cases.get(nn).size()); }
		 */
		int numm = casess.size();
		System.out.println("第" + i + "条测试路径上解个数" + numm);
		int num = 1000;// 一条路径100个测试用例///////////////////////////////////////////////////////////////////////////////////
		if (num > numm) { // 如果一条路径上解小于100，则选取真实个数
			num = numm;
		}
		for (int n1 = 0; n1 < num; n1++) {
			// 4、生成子节点及节点内容
			Element testcase = tcs.addElement("testcase");
			// System.out.println("---------------------testcase"+n1);
			for (int nn = 0; nn < cases.size(); nn++) {// cases.size表示边的个数
				// 添加节点
				Element process = testcase.addElement("process");
				Element operation = process.addElement("operation");
				int random = -1;
				if (random == -1) {
					random = new Random().nextInt(cases.get(nn).size());
				}
				// System.out.println("random-->"+random);
				String value = cases.get(nn).get(random);
				// System.out.println("解value-->"+value);
				String[] cs = value.toString().split("%");
				// System.out.println("operation-->"+cs[0]);
				if (cs[0].contains("flag=1")) {
					String name = cs[0].replace("flag=1", "");
					operation.setText(name);
				} else {
					if (!cs[0].contains("flag=1")) {
						operation.setText(cs[0]);
					}
				}

				Element input = process.addElement("input");
				if (cs[0].contains("flag=1")) {
					input.addAttribute("border", "1");
					input.setText(cs[1]);
				} else {
					input.setText(cs[1]);
				}
				// input.setText(cs[1]);
				// System.out.println("input-->"+cs[1]);
				Element output = process.addElement("output");
				// System.out.println(outtt.get(nn).toString());
				output.setText(cs[2]);

			}
			// System.out.println("---------------------testcase");
			// System.out.println(a.getName());
		}
		////////
		// System.out.println("===========================第"+i+"条测试用例读取完成");
		i++;

		// }//for(Automatic a:testCase)

		// System.out.println("抽象测试序列个数："+testCase.size());
		System.out.println();
		/////////////////////
		/////////////////////

		OutputFormat format = OutputFormat.createPrettyPrint();
		// 6、生成xml文件
		File file = new File(path);

		XMLWriter writer;
		try {
			writer = new XMLWriter(new FileOutputStream(file), format);
			writer.write(dom);
			writer.close();
		} catch (IOException e) {
			e.printStackTrace();
		}

	}

}
